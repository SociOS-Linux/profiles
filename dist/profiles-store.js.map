{"version":3,"file":"profiles-store.js","sourceRoot":"","sources":["../src/profiles-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { CellClient } from '@holochain-open-dev/cell-client';\nimport {\n  AgentPubKeyB64,\n  Dictionary,\n  serializeHash,\n} from '@holochain-open-dev/core-types';\nimport merge from 'lodash-es/merge';\n\nimport { ProfilesService } from './profiles-service';\nimport { AgentProfile, Profile } from './types';\nimport { writable, Writable, derived, Readable, get } from 'svelte/store';\nimport { defaultConfig, ProfilesConfig } from './config';\n\nexport class ProfilesStore {\n  /** Private */\n  private _service: ProfilesService;\n  private _knownProfilesStore: Writable<Dictionary<Profile>> = writable({});\n\n  /** Static info */\n  public myAgentPubKey: AgentPubKeyB64;\n\n  /** Readable stores */\n\n  // Store containing all the profiles that have been fetched\n  // The key is the agentPubKey of the agent\n  public knownProfiles: Readable<Dictionary<Profile>> = derived(\n    this._knownProfilesStore,\n    i => i\n  );\n\n  // Store containing my profile\n  public myProfile: Readable<Profile> = derived(\n    this._knownProfilesStore,\n    profiles => profiles[this.myAgentPubKey]\n  );\n\n  // Returns a store with the profile of the given agent\n  profileOf(agentPubKey: AgentPubKeyB64): Readable<Profile> {\n    return derived(this._knownProfilesStore, profiles => profiles[agentPubKey]);\n  }\n\n  config: ProfilesConfig;\n\n  constructor(\n    protected cellClient: CellClient,\n    config: Partial<ProfilesConfig> = {}\n  ) {\n    this.config = merge(defaultConfig, config);\n    this._service = new ProfilesService(cellClient, this.config.zomeName);\n    this.myAgentPubKey = serializeHash(cellClient.cellId[1]);\n  }\n\n  /** Actions */\n\n  /**\n   * Fetches the profiles for all agents in the DHT\n   *\n   * You can subscribe to `knowProfiles` to get updated with all the profiles when this call is done\n   *\n   * Warning! Can be very slow\n   */\n  async fetchAllProfiles(): Promise<void> {\n    const allProfiles = await this._service.getAllProfiles();\n\n    this._knownProfilesStore.update(profiles => {\n      for (const profile of allProfiles) {\n        profiles[profile.agentPubKey] = profile.profile;\n      }\n      return profiles;\n    });\n  }\n\n  /**\n   * Fetches the profile for the given agent\n   */\n  async fetchAgentProfile(\n    agentPubKey: AgentPubKeyB64\n  ): Promise<Profile | undefined> {\n    // For now, optimistic return of the cached profile\n    // TODO: implement cache invalidation\n\n    const knownProfiles = get(this._knownProfilesStore);\n\n    if (knownProfiles[agentPubKey]) return knownProfiles[agentPubKey];\n\n    const profile = await this._service.getAgentProfile(agentPubKey);\n\n    if (!profile) return;\n\n    this._knownProfilesStore.update(profiles => {\n      profiles[profile.agentPubKey] = profile.profile;\n      return profiles;\n    });\n    return profile.profile;\n  }\n\n  /**\n   * Fetches the profiles for the given agents in the DHT\n   *\n   * You can subscribe to knowProfiles to get updated with all the profiles when this call is done\n   *\n   * Use this over `fetchAgentProfile` when fetching multiple profiles, as it will be more performant\n   */\n  async fetchAgentsProfiles(agentPubKeys: AgentPubKeyB64[]): Promise<void> {\n    // For now, optimistic return of the cached profile\n    // TODO: implement cache invalidation\n\n    const knownProfiles = get(this._knownProfilesStore);\n\n    const agentsWeAlreadKnow = Object.keys(knownProfiles);\n    const profilesToFetch = agentPubKeys.filter(\n      pubKey => !agentsWeAlreadKnow.includes(pubKey)\n    );\n\n    if (profilesToFetch.length === 0) {\n      return;\n    }\n\n    const fetchedProfiles = await this._service.getAgentsProfiles(\n      profilesToFetch\n    );\n\n    this._knownProfilesStore.update(profiles => {\n      for (const fetchedProfile of fetchedProfiles) {\n        profiles[fetchedProfile.agentPubKey] = fetchedProfile.profile;\n      }\n      return profiles;\n    });\n  }\n\n  /**\n   * Fetch my profile\n   *\n   * You can subscribe to `myProfile` to get updated with my profile\n   */\n  async fetchMyProfile(): Promise<void> {\n    const profile = await this._service.getMyProfile();\n    if (profile) {\n      this._knownProfilesStore.update(profiles => {\n        profiles[profile.agentPubKey] = profile.profile;\n        return profiles;\n      });\n    }\n  }\n\n  /**\n   * Search the profiles for the agent with nicknames starting with the given nicknamePrefix\n   *\n   * @param nicknamePrefix must be of at least 3 characters\n   * @returns the profiles with the nickname starting with nicknamePrefix\n   */\n  async searchProfiles(nicknamePrefix: string): Promise<AgentProfile[]> {\n    const searchedProfiles = await this._service.searchProfiles(nicknamePrefix);\n\n    this._knownProfilesStore.update(profiles => {\n      for (const profile of searchedProfiles) {\n        profiles[profile.agentPubKey] = profile.profile;\n      }\n      return profiles;\n    });\n    return searchedProfiles;\n  }\n\n  /**\n   * Create my profile\n   *\n   * Note that there is no guarantee on nickname uniqness\n   *\n   * @param profile profile to be created\n   */\n  async createProfile(profile: Profile): Promise<void> {\n    await this._service.createProfile(profile);\n\n    this._knownProfilesStore.update(profiles => {\n      profiles[this.myAgentPubKey] = profile;\n      return profiles;\n    });\n  }\n\n  /**\n   * Update my profile\n   *\n   * @param profile profile to be created\n   */\n  async updateProfile(profile: Profile): Promise<void> {\n    await this._service.updateProfile(profile);\n\n    this._knownProfilesStore.update(profiles => {\n      profiles[this.myAgentPubKey] = profile;\n      return profiles;\n    });\n  }\n}\n"]}